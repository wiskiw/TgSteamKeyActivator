{"version":3,"sources":["../../src/tl/type-buffer.js"],"names":["isNode","Logger","log","immediate","TypeBufferIntError","findType","val","type","findPred","predicate","findId","id","getNakedType","schema","checkType","substr","result","constructors","find","Error","getPredicate","getTypeConstruct","construct","getChar","e","String","fromCharCode","getString","length","buffer","bytes","next","map","join","addPadding","countNewLength","maxLength","need","offset","e1","e2","max","Math","rounded","ceil","writeIntLogger","writeIntLog","i","field","hex","toString","TypeWriter","constructor","reset","ArrayBuffer","intView","Int32Array","byteView","Uint8Array","set","list","data","checkLength","needBytes","previousBuffer","previousArray","getArray","resultBuffer","resultArray","subarray","getBuffer","getBytesTyped","getBytesPlain","Array","from","writeInt","writePair","n1","n2","field1","field2","TypeBuffer","toUint32","nextByte","nextInt","int","readPair","int1","int2","isEnd","buf","ln","res","Uint32Array","Buffer","byteLength","readUInt32LE","DataView","getUint32"],"mappings":"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","file":"type-buffer.js","sourcesContent":["//@flow\n\nimport isNode from 'detect-node'\n\nimport Logger from 'mtproto-logger'\nconst log = Logger('tl', 'type-buffer')\n\nimport { immediate } from 'mtproto-shared'\nimport { TypeBufferIntError } from '../error'\n\n// import { bigint, uintToInt, intToUint, bytesToHex,\n//   gzipUncompress, bytesToArrayBuffer, longToInts, lshift32 } from '../bin'\n\nimport type { BinaryData, TLConstruct, TLSchema } from './index.h'\n\nfunction findType(val: TLConstruct) {\n  return val.type == this\n}\n\nfunction findPred(val: TLConstruct) {\n  return val.predicate == this\n}\n\nfunction findId(val: TLConstruct) {\n  return val.id == this\n}\n\nexport const getNakedType = (type: string, schema: TLSchema) => {\n  const checkType = type.substr(1)\n  const result = schema.constructors.find(findType, checkType)\n  if (!result)\n    throw new Error(`Constructor not found for type: ${type}`)\n  return result\n}\n\nexport const getPredicate = (type: string, schema: TLSchema) => {\n  const result = schema.constructors.find(findPred, type)\n  if (!result)\n    throw new Error(`Constructor not found for predicate: ${type}`)\n  return result\n}\n\nexport const getTypeConstruct =\n  (construct: number, schema: TLSchema) =>\n    schema.constructors.find(findId, construct)\n\nconst getChar = (e: number) => String.fromCharCode(e)\n\nexport const getString = (length: number, buffer: TypeBuffer) => {\n  const bytes = buffer.next(length)\n\n  const result = [...bytes].map(getChar).join('')\n  buffer.addPadding()\n  return result\n}\n\nconst countNewLength = (maxLength: number, need: number, offset: number) => {\n  const e1 = maxLength * 2\n  const e2 = offset + need + 16\n  const max = Math.max(e1, e2) / 4\n  const rounded = Math.ceil(max) * 4\n  return rounded\n}\n\nconst writeIntLogger = log('writeInt')\n\nconst writeIntLog = (i: number, field: string) => {\n  const hex = i && i.toString(16) || 'UNDEF'\n  writeIntLogger(hex, i, field)\n}\n\nexport class TypeWriter {\n  offset: number = 0 // in bytes\n  buffer: ArrayBuffer\n  intView: Int32Array\n  byteView: Uint8Array\n  maxLength: number\n  constructor(/*startMaxLength: number*/) {\n    // this.maxLength = startMaxLength\n    // this.reset()\n  }\n  reset() {\n    this.buffer = new ArrayBuffer(this.maxLength)\n    this.intView = new Int32Array(this.buffer)\n    this.byteView = new Uint8Array(this.buffer)\n  }\n  set(list: BinaryData, length: number) {\n    this.byteView.set(list, this.offset)\n    this.offset += length\n  }\n  next(data: number) {\n    this.byteView[this.offset] = data\n    this.offset++\n  }\n  checkLength(needBytes: number) {\n    if (this.offset + needBytes < this.maxLength) {\n      return\n    }\n    log('Increase buffer')(this.offset, needBytes, this.maxLength)\n    this.maxLength = countNewLength(\n      this.maxLength,\n      needBytes,\n      this.offset\n    )\n    const previousBuffer = this.buffer\n    const previousArray = new Int32Array(previousBuffer)\n\n    this.reset()\n\n    new Int32Array(this.buffer).set(previousArray)\n  }\n  getArray() {\n    const resultBuffer = new ArrayBuffer(this.offset)\n    const resultArray = new Int32Array(resultBuffer)\n\n    resultArray.set(this.intView.subarray(0, this.offset / 4))\n\n    return resultArray\n  }\n  getBuffer() {\n    return this.getArray().buffer\n  }\n  getBytesTyped() {\n    const resultBuffer = new ArrayBuffer(this.offset)\n    const resultArray = new Uint8Array(resultBuffer)\n\n    resultArray.set(this.byteView.subarray(0, this.offset))\n\n    return resultArray\n  }\n  getBytesPlain(): number[] {\n    return Array.from(this.byteView.subarray(0, this.offset))\n  }\n  writeInt(i: number, field: string) {\n    immediate(writeIntLog, i, field)\n\n    this.checkLength(4)\n    this.intView[this.offset / 4] = i\n    this.offset += 4\n  }\n  writePair(n1: number, n2: number, field1: string, field2: string) {\n    this.writeInt(n1, field1)\n    this.writeInt(n2, field2)\n  }\n  addPadding() {\n    while (this.offset % 4)\n      this.next(0)\n  }\n}\n\nexport class TypeBuffer {\n  offset: number = 0\n  buffer: Buffer | ArrayBuffer\n  intView: Uint32Array\n  byteView: Uint8Array\n  constructor(buffer: Buffer | ArrayBuffer) {\n    this.buffer = buffer\n    this.intView = toUint32(buffer)\n    this.byteView = new Uint8Array(buffer)\n  }\n\n  nextByte() {\n    return this.byteView[this.offset++]\n  }\n  nextInt() {\n    if (this.offset >= this.intView.length * 4)\n      throw new TypeBufferIntError(this)\n    const int = this.intView[this.offset / 4]\n    this.offset += 4\n    return int\n  }\n  readPair() {\n    const int1 = this.nextInt()\n    const int2 = this.nextInt()\n    return [ int1, int2 ]\n  }\n  next(length: number) {\n    const result = this.byteView.subarray(this.offset, this.offset + length)\n    this.offset += length\n    return result\n  }\n  isEnd() {\n    return this.offset === this.byteView.length\n  }\n  addPadding() {\n    const offset = this.offset % 4\n    if (offset > 0)\n      this.offset += 4 - offset\n  }\n}\n\nconst toUint32 = (buf: Buffer | ArrayBuffer) => {\n  let ln, res\n  if (!isNode) //TODO browser behavior not equals, why?\n    return new Uint32Array( buf )\n  if (buf instanceof Buffer) {\n    ln = buf.byteLength / 4\n    res = new Uint32Array( ln )\n    for (let i = 0; i < ln; i++)\n      res[i] = buf.readUInt32LE( i*4 )\n  } else {\n    const data = new DataView( buf )\n    ln = data.byteLength / 4\n    res = new Uint32Array( ln )\n    for (let i = 0; i < ln; i++)\n      res[i] = data.getUint32( i*4, true )\n  }\n  return res\n}\n"]}