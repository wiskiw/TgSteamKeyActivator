{"version":3,"sources":["../../../src/service/chain/encrypted-message.js"],"names":["CryptoWorker","getMsgKeyIv","writeInt","writeIntBytes","writeLong","NetMessage","TypeWriter","apiMessage","ctx","serverSalt","sessionID","message","msg_id","seq_no","body","length","apiBytes","getBuffer","encryptApiBytes","bytes","authKey","bytesHash","sha1Hash","msgKey","Uint8Array","subarray","aesKey","aesIv","encryptedBytes","aesEncrypt","mtMessage","authKeyID","mtBytes","getArray"],"mappings":";;AAEA,OAAOA,YAAP,MAAyB,cAAzB;AACA,OAAOC,WAAP,MAAwB,WAAxB;AACA,SAASC,QAAT,EAAmBC,aAAnB,EAAkCC,SAAlC,QAAmD,iBAAnD;;AAEA,SAASC,UAAT,QAA2B,0BAA3B;AACA,SAASC,UAAT,QAA2B,sBAA3B;;AAEA;;AAEA;;;AAuBA,OAAO,IAAMC,aAAa,CAAC,EAAEC,GAAF,EAAOC,UAAP,EAAmBC,SAAnB,EAA8BC,OAA9B,EAAD,KAA8D;AACtFR,gBAAcK,GAAd,EAAmBC,UAAnB,EAA+B,EAA/B;AACAN,gBAAcK,GAAd,EAAmBE,SAAnB,EAA8B,EAA9B;AACAN,YAAUI,GAAV,EAAeG,QAAQC,MAAvB,EAA+B,YAA/B;AACAV,WAASM,GAAT,EAAcG,QAAQE,MAAtB,EAA8B,QAA9B;;AAEAX,WAASM,GAAT,EAAcG,QAAQG,IAAR,CAAaC,MAA3B,EAAmC,qBAAnC;AACAZ,gBAAcK,GAAd,EAAmBG,QAAQG,IAA3B,EAAiC,KAAjC;;AAEA,MAAME,WAAWR,IAAIS,SAAJ,EAAjB;;AAEA,SAAOD,QAAP;AACD,CAZM;;AAcP,OAAO,IAAME;AAAA,+BAAkB,WAAM,EAAEC,KAAF,EAASC,OAAT,EAAN,EAAqD;AAClF,QAAMC,YAAY,MAAMrB,aAAasB,QAAb,CAAsBH,KAAtB,CAAxB;AACA,QAAMI,SAAS,IAAIC,UAAJ,CAAeH,SAAf,EAA0BI,QAA1B,CAAmC,CAAnC,EAAsC,EAAtC,CAAf;AACA,QAAM,CAACC,MAAD,EAASC,KAAT,IAAkB,MAAM1B,YAAYmB,OAAZ,EAAqBG,MAArB,EAA6B,IAA7B,CAA9B;AACA,QAAMK,iBAAiB,MAAM5B,aAAa6B,UAAb,CAAwBV,KAAxB,EAA+BO,MAA/B,EAAuCC,KAAvC,CAA7B;;AAEA,WAAO,EAAEC,cAAF,EAAkBL,MAAlB,EAAP;AACD,GAPY;;AAAA;AAAA;AAAA;AAAA,IAAN;;AASP,OAAO,IAAMO,YAAY,CAAC,EAAEtB,GAAF,EAAOuB,SAAP,EAAkBR,MAAlB,EAA0BK,cAA1B,EAAD,KAAgE;AACvFzB,gBAAcK,GAAd,EAAmBuB,SAAnB,EAA8B,EAA9B;AACA5B,gBAAcK,GAAd,EAAmBe,MAAnB,EAA2B,GAA3B;AACApB,gBAAcK,GAAd,EAAmBoB,cAAnB,EAAmC,KAAnC;;AAEA,MAAMI,UAAUxB,IAAIyB,QAAJ,EAAhB;;AAEA,SAAOD,OAAP;AACD,CARM","file":"encrypted-message.js","sourcesContent":["//@flow\n\nimport CryptoWorker from '../../crypto'\nimport getMsgKeyIv from './msg-key'\nimport { writeInt, writeIntBytes, writeLong } from '../../tl/writer'\n\nimport { NetMessage } from '../networker/net-message'\nimport { TypeWriter } from '../../tl/type-buffer'\n\n// import Logger from 'mtproto-logger'\n\n// const log = Logger`encrypted message`\n\n\ntype ApiMessageProps = {\n  ctx: TypeWriter,\n  serverSalt: number[],\n  sessionID: number[],\n  message: NetMessage\n}\n\ntype EncryptApiMessageProps = {\n  bytes: ArrayBuffer,\n  authKey: Uint8Array\n}\n\ntype MtMessageProps = {\n  ctx: TypeWriter,\n  authKeyID: number[],\n  msgKey: Uint8Array,\n  encryptedBytes: ArrayBuffer\n}\n\n\nexport const apiMessage = ({ ctx, serverSalt, sessionID, message }: ApiMessageProps) => {\n  writeIntBytes(ctx, serverSalt, 64)\n  writeIntBytes(ctx, sessionID, 64)\n  writeLong(ctx, message.msg_id, 'message_id')\n  writeInt(ctx, message.seq_no, 'seq_no')\n\n  writeInt(ctx, message.body.length, 'message_data_length')\n  writeIntBytes(ctx, message.body, false)\n\n  const apiBytes = ctx.getBuffer()\n\n  return apiBytes\n}\n\nexport const encryptApiBytes = async({ bytes, authKey }: EncryptApiMessageProps) => {\n  const bytesHash = await CryptoWorker.sha1Hash(bytes)\n  const msgKey = new Uint8Array(bytesHash).subarray(4, 20)\n  const [aesKey, aesIv] = await getMsgKeyIv(authKey, msgKey, true)\n  const encryptedBytes = await CryptoWorker.aesEncrypt(bytes, aesKey, aesIv)\n\n  return { encryptedBytes, msgKey }\n}\n\nexport const mtMessage = ({ ctx, authKeyID, msgKey, encryptedBytes }: MtMessageProps) => {\n  writeIntBytes(ctx, authKeyID, 64)\n  writeIntBytes(ctx, msgKey, 128)\n  writeIntBytes(ctx, encryptedBytes, false)\n\n  const mtBytes = ctx.getArray()\n\n  return mtBytes\n}\n\n"]}