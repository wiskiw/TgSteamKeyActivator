{"version":3,"sources":["../../src/event/rpc.js"],"names":["log","onRpcError","rpcError","errorMessage","error_message","matches","match","errorCode","error_code","code","type","description","migrateRegexp","fileMigrateRegexp","isMigrateError","err","test","isFileMigrateError","getMigrateDc","regExp","matched","length","newDcID","isFinite","newDc","parseInt","getFileMigrateDc"],"mappings":";;;;;;;AAEA;;AACA;;AACA;;;;;;AACA,IAAMA,MAAM,uBAAO,YAAnB;;AAOO,IAAMC,kCAAcC,QAAD,IAA2B;AACnD,MAAMC,eAAeD,SAASE,aAAT,IAA0B,EAA/C;AACA,MAAMC,UAAWF,YAAD,CAAeG,KAAf,CAAqB,0BAArB,KAAoD,EAApE;AACA,MAAMC,YAAY,oBAAUL,SAASM,UAAT,IAAuB,CAAjC,CAAlB;AACA,MAAMC,OAAO,CAACF,SAAD,IAAcA,aAAa,CAA3B,GACP,GADO,GAEPA,SAFN;AAGA,MAAMG,OAAOL,QAAQ,CAAR,KAAc,SAA3B;AACA,MAAMM,cAAcN,QAAQ,CAAR,KAAe,QAAOI,IAAK,IAAGN,YAAa,EAA/D;AACA,SAAO,oBAAaM,IAAb,EAAmBC,IAAnB,EAAyBC,WAAzB,EAAsCT,QAAtC,CAAP;AACD,CAVM;;AAYP,IAAMU,gBAAgB,uDAAtB;AACA,IAAMC,oBAAoB,uBAA1B;;AAEO,IAAMC,0CAAkBC,GAAD,IAAmBH,cAAcI,IAAd,CAAmBD,IAAIL,IAAvB,CAA1C;AACA,IAAMO,kDAAsBF,GAAD,IAAmBF,kBAAkBG,IAAlB,CAAuBD,IAAIL,IAA3B,CAA9C;;AAEA,IAAMQ,sCAAe,CAACH,GAAD,EAAgBI,SAAiBP,aAAjC,KAAmD;AAC7E,MAAMQ,UAAUL,IAAIL,IAAJ,CAASJ,KAAT,CAAea,MAAf,CAAhB;AACA,MAAI,CAACC,OAAD,IAAYA,QAAQC,MAAR,GAAiB,CAAjC,EAAoC;AAClCrB,QAAI,SAAJ,EAAe,uBAAf,EAAwCe,IAAIL,IAA5C;AACA,WAAO,IAAP;AACD;AACD,MAAM,IAAMY,OAAN,IAAiBF,OAAvB;AACA,MAAI,CAACG,SAASD,OAAT,CAAL,EAAwB;AACtBtB,QAAI,SAAJ,EAAe,gBAAf,EAAiC,YAAjC,EAA+CsB,OAA/C;AACA,WAAO,IAAP;AACD;AACD,MAAME,QAAQC,SAASH,OAAT,EAAkB,EAAlB,CAAd;AACA,SAAOE,KAAP;AACD,CAbM;;AAeA,IAAME,8CAAoBX,GAAD,IAAmBG,aAAaH,GAAb,EAAkBF,iBAAlB,CAA5C","file":"rpc.js","sourcesContent":["//@flow\n\nimport { uintToInt } from '../bin'\nimport { RpcError } from '../error'\nimport Logger from 'mtproto-logger'\nconst log = Logger`event, rpc`\n\nexport type RpcRawError = {\n  error_message?: string,\n  error_code?: number,\n}\n\nexport const onRpcError = (rpcError: RpcRawError) => {\n  const errorMessage = rpcError.error_message || ''\n  const matches = (errorMessage).match(/^([A-Z_0-9]+\\b)(: (.+))?/) || []\n  const errorCode = uintToInt(rpcError.error_code || 0)\n  const code = !errorCode || errorCode <= 0\n      ? 500\n      : errorCode\n  const type = matches[1] || 'UNKNOWN'\n  const description = matches[3] || `CODE#${code} ${errorMessage}`\n  return new RpcError(code, type, description, rpcError)\n}\n\nconst migrateRegexp = /^(PHONE_MIGRATE_|NETWORK_MIGRATE_|USER_MIGRATE_)(\\d+)/\nconst fileMigrateRegexp = /^(FILE_MIGRATE_)(\\d+)/\n\nexport const isMigrateError = (err: RpcError) => migrateRegexp.test(err.type)\nexport const isFileMigrateError = (err: RpcError) => fileMigrateRegexp.test(err.type)\n\nexport const getMigrateDc = (err: RpcError, regExp: RegExp = migrateRegexp) => {\n  const matched = err.type.match(regExp)\n  if (!matched || matched.length < 2) {\n    log('warning')('no matched error type', err.type)\n    return null\n  }\n  const [ , , newDcID] = matched\n  if (!isFinite(newDcID)) {\n    log('warning', 'migrated error')('invalid dc', newDcID)\n    return null\n  }\n  const newDc = parseInt(newDcID, 10)\n  return newDc\n}\n\nexport const getFileMigrateDc = (err: RpcError) => getMigrateDc(err, fileMigrateRegexp)\n"]}